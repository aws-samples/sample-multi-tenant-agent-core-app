<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Tenant Bedrock Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.12/dist/amazon-cognito-identity.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .login-form, .chat-interface { display: none; }
        .login-form.active, .chat-interface.active { display: block; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, button { padding: 15px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 16px; }
        #messageInput { 
            padding: 25px; 
            font-size: 20px; 
            min-height: 80px; 
            background-color: #ffffff; 
            color: #333333; 
            border: 2px solid #007bff; 
            line-height: 1.5;
        }
        #messageInput:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }
        button { background-color: #007bff; color: white; cursor: pointer; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        .chat-box { border: 1px solid #ddd; height: 400px; overflow-y: scroll; padding: 15px; margin: 15px 0; background-color: #fafafa; }
        .message { margin: 10px 0; padding: 10px; border-radius: 8px; }
        .user { background-color: #007bff; color: white; text-align: right; }
        .agent { background-color: #e9ecef; }
        .tenant-info { background-color: #d4edda; padding: 15px; margin: 15px 0; border-radius: 4px; border: 1px solid #c3e6cb; }
        .error { color: #dc3545; margin: 10px 0; }
        .success { color: #28a745; margin: 10px 0; }
        .input-group { display: flex; gap: 10px; margin: 10px 0; }
        .logout-btn { background-color: #dc3545; }
        .logout-btn:hover { background-color: #c82333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Multi-Tenant Bedrock Chat</h1>
        
        <!-- Login Form -->
        <div id="loginForm" class="login-form active">
            <h2>Login</h2>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" placeholder="user@company.com" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" required>
            </div>
            <button onclick="login()">Login</button>
            <div id="loginError" class="error"></div>
            
            <hr style="margin: 30px 0;">
            <h3>New User Registration</h3>
            <div class="form-group">
                <label for="regFirstName">First Name:</label>
                <input type="text" id="regFirstName" placeholder="John" required>
            </div>
            <div class="form-group">
                <label for="regLastName">Last Name:</label>
                <input type="text" id="regLastName" placeholder="Doe" required>
            </div>
            <div class="form-group">
                <label for="regEmail">Email:</label>
                <input type="email" id="regEmail" placeholder="user@company.com" required>
            </div>
            <div class="form-group">
                <label for="regPassword">Password:</label>
                <input type="password" id="regPassword" required>
            </div>
            <div class="form-group">
                <label for="regTenant">Organization:</label>
                <select id="regTenant">
                    <option value="acme-corp">Acme Corporation</option>
                    <option value="beta-inc">Beta Industries</option>
                    <option value="gamma-llc">Gamma LLC</option>
                </select>
            </div>
            <div class="form-group">
                <label for="regTier">Subscription Tier:</label>
                <select id="regTier">
                    <option value="basic">Basic (Free) - 50 daily messages</option>
                    <option value="advanced">Advanced ($29/month) - 200 daily messages + MCP tools</option>
                    <option value="premium">Premium ($99/month) - 1000 daily messages + Full MCP access</option>
                </select>
            </div>
            <div class="form-group">
                <label for="regRole">User Role:</label>
                <select id="regRole">
                    <option value="user">Regular User</option>
                    <option value="admin">Admin (Cost Reports Access)</option>
                </select>
            </div>
            <button onclick="register()">Register</button>
            <div id="registerError" class="error"></div>
            <div id="registerSuccess" class="success"></div>
        </div>

        <!-- Chat Interface -->
        <div id="chatInterface" class="chat-interface">
            <div class="tenant-info">
                <h3>Welcome!</h3>
                <div id="userInfo"></div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
            
            <div id="chatBox" class="chat-box"></div>
            
            <div class="input-group">
                <textarea id="messageInput" placeholder="Type your message here..." style="flex: 1; padding: 25px; font-size: 20px; min-height: 100px; background-color: #ffffff; color: #333333; border: 2px solid #007bff; resize: vertical; font-family: Arial, sans-serif;"></textarea>
                <button onclick="sendMessage()" style="padding: 25px 35px; font-size: 20px; min-height: 100px; margin-left: 10px;">Send</button>
            </div>
            
            <div class="input-group">
                <button onclick="getUsage()">View Usage</button>
                <button onclick="getSessions()">View Sessions</button>
                <button onclick="getSubscriptionInfo()">Subscription Info</button>
                <button onclick="getMCPTools()">MCP Tools</button>
            </div>
            
            <div class="input-group">
                <button onclick="getCostReport()" style="background-color: #28a745;">üí∞ Cost Report</button>
                <button onclick="getUserCosts()" style="background-color: #17a2b8;">üë§ My Costs</button>
            </div>
            
            <div class="input-group" id="adminControls" style="display: none;">
                <button onclick="getAdminOverallCost()" style="background-color: #dc3545;">üîí Admin: Overall Cost</button>
                <button onclick="getAdminPerUserCost()" style="background-color: #fd7e14;">üîí Admin: Per User</button>
                <button onclick="getAdminServiceCost()" style="background-color: #6610f2;">üîí Admin: Service-wise</button>
                <button onclick="getComprehensiveReport()" style="background-color: #e83e8c;">üîí Admin: Full Report</button>
            </div>
            
            <div id="usageInfo"></div>
        </div>
    </div>

    <script>
        // Configuration - Update these with your deployed values
        const CONFIG = {
            userPoolId: 'us-east-1_1UZVUhKiZ',
            clientId: '1jjpsqmi3qhngfmh871tgns4p2', 
            region: 'us-east-1',
            apiUrl: 'http://localhost:8000'
        };

        let currentUser = null;
        let currentSession = null;
        let cognitoUser = null;

        // Initialize Cognito
        const poolData = {
            UserPoolId: CONFIG.userPoolId,
            ClientId: CONFIG.clientId
        };
        const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

        async function register() {
            const firstName = document.getElementById('regFirstName').value;
            const lastName = document.getElementById('regLastName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const tenantId = document.getElementById('regTenant').value;
            const role = document.getElementById('regRole').value;
            
            const attributeList = [
                new AmazonCognitoIdentity.CognitoUserAttribute({
                    Name: 'email',
                    Value: email
                }),
                new AmazonCognitoIdentity.CognitoUserAttribute({
                    Name: 'given_name',
                    Value: firstName
                }),
                new AmazonCognitoIdentity.CognitoUserAttribute({
                    Name: 'family_name',
                    Value: lastName
                }),
                new AmazonCognitoIdentity.CognitoUserAttribute({
                    Name: 'custom:tenant_id',
                    Value: tenantId
                }),
                new AmazonCognitoIdentity.CognitoUserAttribute({
                    Name: 'custom:subscription_tier',
                    Value: document.getElementById('regTier').value
                })
            ];

            userPool.signUp(email, password, attributeList, null, async (err, result) => {
                if (err) {
                    document.getElementById('registerError').textContent = err.message;
                    return;
                }
                
                // If admin role selected, add to admin group after verification
                const isAdmin = role === 'admin';
                
                // Show verification code input
                document.getElementById('registerSuccess').innerHTML = 
                    `Registration successful! Please check your email for verification code.<br>
                     ${isAdmin ? '<strong style="color: #dc3545;">üîí Admin access will be granted after verification</strong><br>' : ''}
                     <input type="text" id="verificationCode" placeholder="Enter verification code" style="margin: 10px 0; padding: 8px;">
                     <button onclick="confirmSignUp('${email}', '${tenantId}', ${isAdmin})">Verify</button>`;
                document.getElementById('registerError').textContent = '';
            });
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const authenticationData = {
                Username: email,
                Password: password
            };
            
            const authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
            
            const userData = {
                Username: email,
                Pool: userPool
            };
            
            cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
            
            cognitoUser.authenticateUser(authenticationDetails, {
                onSuccess: (result) => {
                    const idToken = result.getIdToken().getJwtToken();
                    const payload = result.getIdToken().payload;
                    
                    currentUser = {
                        email: payload.email,
                        tenant_id: payload['custom:tenant_id'],
                        subscription_tier: payload['custom:subscription_tier'] || 'basic',
                        user_id: payload.sub,
                        token: idToken
                    };
                    
                    showChatInterface();
                },
                onFailure: (err) => {
                    document.getElementById('loginError').textContent = err.message;
                }
            });
        }

        function showChatInterface() {
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('chatInterface').classList.add('active');
            
            document.getElementById('userInfo').innerHTML = 
                `<strong>User:</strong> ${currentUser.email}<br>
                 <strong>Organization:</strong> ${currentUser.tenant_id}<br>
                 <strong>Subscription:</strong> ${currentUser.subscription_tier.toUpperCase()}<br>
                 <strong>User ID:</strong> ${currentUser.user_id}`;
            
            // Check if user is admin and show admin controls
            checkAdminAccess();
            
            createSession();
        }
        
        async function checkAdminAccess() {
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/admin/my-tenants`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const adminData = await response.json();
                    document.getElementById('adminControls').style.display = 'block';
                    document.getElementById('userInfo').innerHTML += 
                        `<br><strong style="color: #dc3545;">üîí ADMIN ACCESS</strong> for: ${adminData.admin_tenants.join(', ')}`;
                }
            } catch (error) {
                // User is not admin, keep admin controls hidden
            }
        }

        async function createSession() {
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/sessions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    currentSession = await response.json();
                    addMessageToChat('system', `Session created: ${currentSession.session_id}`);
                } else {
                    addMessageToChat('system', 'Failed to create session');
                }
            } catch (error) {
                addMessageToChat('system', `Error: ${error.message}`);
            }
        }

        async function sendMessage() {
            if (!currentSession) {
                addMessageToChat('system', 'No active session');
                return;
            }
            
            const message = document.getElementById('messageInput').value;
            if (!message) return;
            
            addMessageToChat('user', message);
            document.getElementById('messageInput').value = '';
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        tenant_context: {
                            tenant_id: currentUser.tenant_id,
                            user_id: currentUser.user_id,
                            session_id: currentSession.session_id
                        }
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addMessageToChat('agent', result.response);
                } else {
                    addMessageToChat('system', 'Failed to send message');
                }
            } catch (error) {
                addMessageToChat('system', `Error: ${error.message}`);
            }
        }

        function addMessageToChat(sender, message) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function getUsage() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/tenants/${currentUser.tenant_id}/usage`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const usage = await response.json();
                    document.getElementById('usageInfo').innerHTML = 
                        `<h3>Usage for ${usage.tenant_id}</h3>
                         <p>Total Messages: ${usage.total_messages}</p>
                         <p>Active Sessions: ${usage.sessions}</p>
                         <pre>${JSON.stringify(usage.metrics, null, 2)}</pre>`;
                }
            } catch (error) {
                console.error('Error getting usage:', error);
            }
        }

        async function getSessions() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/tenants/${currentUser.tenant_id}/sessions`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const sessions = await response.json();
                    document.getElementById('usageInfo').innerHTML = 
                        `<h3>Sessions for ${sessions.tenant_id}</h3>
                         <pre>${JSON.stringify(sessions.sessions, null, 2)}</pre>`;
                }
            } catch (error) {
                console.error('Error getting sessions:', error);
            }
        }

        async function getSubscriptionInfo() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/tenants/${currentUser.tenant_id}/subscription`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const info = await response.json();
                    document.getElementById('usageInfo').innerHTML = 
                        `<h3>üè∑Ô∏è Subscription: ${info.subscription_tier.toUpperCase()}</h3>
                         <h4>Limits:</h4>
                         <p>Daily Messages: ${info.limits.daily_messages}</p>
                         <p>Monthly Messages: ${info.limits.monthly_messages}</p>
                         <p>Session Duration: ${info.limits.max_session_duration} minutes</p>
                         <p>Concurrent Sessions: ${info.limits.concurrent_sessions}</p>
                         <p>MCP Access: ${info.limits.mcp_server_access ? '‚úÖ' : '‚ùå'}</p>
                         <h4>Current Usage:</h4>
                         <p>Daily: ${info.current_usage.daily_usage}/${info.limits.daily_messages}</p>
                         <p>Monthly: ${info.current_usage.monthly_usage}/${info.limits.monthly_messages}</p>
                         <p>Active Sessions: ${info.current_usage.active_sessions}/${info.limits.concurrent_sessions}</p>`;
                }
            } catch (error) {
                console.error('Error getting subscription info:', error);
            }
        }

        async function getMCPTools() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/mcp/tools`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const tools = await response.json();
                    let toolsHtml = `<h3>üîß MCP Tools (${tools.subscription_tier.toUpperCase()})</h3>`;
                    
                    if (tools.available_tools.length === 0) {
                        toolsHtml += '<p>‚ùå No MCP tools available for your subscription tier</p>';
                    } else {
                        toolsHtml += '<p>Available tools:</p><ul>';
                        tools.available_tools.forEach(tool => {
                            toolsHtml += `<li><button onclick="testMCPTool('${tool}')">${tool}</button></li>`;
                        });
                        toolsHtml += '</ul>';
                    }
                    
                    document.getElementById('usageInfo').innerHTML = toolsHtml;
                }
            } catch (error) {
                console.error('Error getting MCP tools:', error);
            }
        }

        async function testMCPTool(toolName) {
            if (!currentUser) return;
            
            const testArgs = {
                'get_tier_info': { tier: currentUser.subscription_tier },
                'upgrade_tier': { tenant_id: currentUser.tenant_id, new_tier: 'premium' },
                'get_usage_analytics': { tenant_id: currentUser.tenant_id },
                'manage_limits': { action: 'increase', tenant_id: currentUser.tenant_id, limit_type: 'daily' }
            };
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/mcp/tools/${toolName}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentUser.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testArgs[toolName] || {})
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addMessageToChat('system', `MCP Tool ${toolName}: ${JSON.stringify(result.result, null, 2)}`);
                } else {
                    addMessageToChat('system', `MCP Tool ${toolName} failed`);
                }
            } catch (error) {
                addMessageToChat('system', `Error executing MCP tool: ${error.message}`);
            }
        }

        function confirmSignUp(email, tenantId, isAdmin) {
            const verificationCode = document.getElementById('verificationCode').value;
            
            const userData = {
                Username: email,
                Pool: userPool
            };
            
            const cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
            
            cognitoUser.confirmRegistration(verificationCode, true, async (err, result) => {
                if (err) {
                    document.getElementById('registerError').textContent = err.message;
                    return;
                }
                
                // If admin role, add to admin group
                if (isAdmin) {
                    try {
                        const response = await fetch(`${CONFIG.apiUrl}/api/admin/add-to-group`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                email: email,
                                tenant_id: tenantId
                            })
                        });
                        
                        if (response.ok) {
                            document.getElementById('registerSuccess').textContent = 
                                '‚úÖ Email verified and admin access granted! You can now login with admin privileges.';
                        } else {
                            document.getElementById('registerSuccess').textContent = 
                                '‚úÖ Email verified! Admin access pending - contact support.';
                        }
                    } catch (error) {
                        document.getElementById('registerSuccess').textContent = 
                            '‚úÖ Email verified! Admin access pending - contact support.';
                    }
                } else {
                    document.getElementById('registerSuccess').textContent = 
                        '‚úÖ Email verified successfully! You can now login.';
                }
                
                document.getElementById('registerError').textContent = '';
            });
        }

        async function getCostReport() {
            if (!currentUser) return;
            
            const days = prompt('Enter number of days for cost report (default: 30):', '30');
            const daysParam = days ? parseInt(days) : 30;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/tenants/${currentUser.tenant_id}/costs?days=${daysParam}`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const costHtml = `
                        <h3>üí∞ Cost Report (${daysParam} days)</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                            <h4>Total Cost: $${data.total_cost.toFixed(4)}</h4>
                            <p><strong>Bedrock:</strong> $${data.cost_breakdown.bedrock_costs.toFixed(4)}</p>
                            <p><strong>Weather API:</strong> $${data.cost_breakdown.weather_api_costs.toFixed(4)}</p>
                            <p><strong>Agent Runtime:</strong> $${data.cost_breakdown.agent_runtime_costs.toFixed(4)}</p>
                            <p><strong>Total Invocations:</strong> ${data.cost_breakdown.total_invocations}</p>
                            <p><strong>Total Tokens:</strong> ${data.cost_breakdown.total_tokens.input + data.cost_breakdown.total_tokens.output}</p>
                        </div>
                        <h4>User Breakdown:</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${Object.entries(data.users).map(([userId, userCost]) => 
                                `<p><strong>${userId}:</strong> $${userCost.total_cost.toFixed(4)} (${userCost.invocations} invocations)</p>`
                            ).join('')}
                        </div>
                    `;
                    document.getElementById('usageInfo').innerHTML = costHtml;
                } else {
                    document.getElementById('usageInfo').innerHTML = '<p>Error loading cost report</p>';
                }
            } catch (error) {
                console.error('Error getting cost report:', error);
            }
        }
        
        async function getUserCosts() {
            if (!currentUser) return;
            
            const days = prompt('Enter number of days for your cost report (default: 30):', '30');
            const daysParam = days ? parseInt(days) : 30;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/tenants/${currentUser.tenant_id}/users/${currentUser.user_id}/costs?days=${daysParam}`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const userCostHtml = `
                        <h3>üë§ My Costs (${daysParam} days)</h3>
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 10px 0;">
                            <h4>My Total Cost: $${data.total_cost.toFixed(4)}</h4>
                            <p><strong>Bedrock:</strong> $${data.bedrock_cost.toFixed(4)}</p>
                            <p><strong>Weather API:</strong> $${data.weather_api_cost.toFixed(4)}</p>
                            <p><strong>Agent Runtime:</strong> $${data.agent_runtime_cost.toFixed(4)}</p>
                            <p><strong>My Invocations:</strong> ${data.invocations}</p>
                            <p><strong>My Tokens:</strong> ${data.tokens.input + data.tokens.output} (${data.tokens.input} input, ${data.tokens.output} output)</p>
                        </div>
                    `;
                    document.getElementById('usageInfo').innerHTML = userCostHtml;
                } else {
                    document.getElementById('usageInfo').innerHTML = '<p>Error loading your cost report</p>';
                }
            } catch (error) {
                console.error('Error getting user costs:', error);
            }
        }

        async function getAdminOverallCost() {
            if (!currentUser) return;
            
            const days = prompt('Enter days for admin overall cost report (default: 30):', '30');
            const daysParam = days ? parseInt(days) : 30;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/admin/tenants/${currentUser.tenant_id}/overall-cost?days=${daysParam}`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const adminHtml = `
                        <h3>üîí ADMIN: Overall Tenant Cost (${daysParam} days)</h3>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 5px; border: 1px solid #ffeaa7;">
                            <h4>Total: $${data.total_cost.toFixed(4)}</h4>
                            <h5>Service Breakdown:</h5>
                            ${Object.entries(data.service_breakdown).map(([service, cost]) => 
                                `<p><strong>${service}:</strong> $${cost.toFixed(4)} (${data.cost_per_service_percentage[service].toFixed(1)}%)</p>`
                            ).join('')}
                        </div>
                    `;
                    document.getElementById('usageInfo').innerHTML = adminHtml;
                }
            } catch (error) {
                document.getElementById('usageInfo').innerHTML = '<p>Admin access required</p>';
            }
        }
        
        async function getAdminPerUserCost() {
            if (!currentUser) return;
            
            const days = prompt('Enter days for per-user cost report (default: 30):', '30');
            const daysParam = days ? parseInt(days) : 30;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/admin/tenants/${currentUser.tenant_id}/per-user-cost?days=${daysParam}`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const userList = Object.entries(data.users).map(([userId, userData]) => 
                        `<div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px;">
                            <strong>${userId}:</strong> $${userData.total_cost.toFixed(4)}<br>
                            <small>Invocations: ${userData.usage_stats.invocations}, Tokens: ${userData.usage_stats.tokens.input + userData.usage_stats.tokens.output}</small>
                        </div>`
                    ).join('');
                    
                    document.getElementById('usageInfo').innerHTML = `
                        <h3>üîí ADMIN: Per User Costs (${daysParam} days)</h3>
                        <div style="max-height: 300px; overflow-y: auto;">${userList}</div>
                    `;
                }
            } catch (error) {
                document.getElementById('usageInfo').innerHTML = '<p>Admin access required</p>';
            }
        }
        
        async function getAdminServiceCost() {
            if (!currentUser) return;
            
            const days = prompt('Enter days for service-wise cost report (default: 30):', '30');
            const daysParam = days ? parseInt(days) : 30;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/admin/tenants/${currentUser.tenant_id}/service-wise-cost?days=${daysParam}`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const serviceList = Object.entries(data.service_breakdown).map(([service, serviceData]) => 
                        `<div style="margin: 10px 0; padding: 10px; background: #e3f2fd; border-radius: 3px;">
                            <strong>${service}:</strong> $${serviceData.total_cost.toFixed(4)}<br>
                            <small>Usage: ${serviceData.usage_count}, Avg: $${serviceData.average_cost_per_use.toFixed(6)}</small><br>
                            <small>Peak Day: ${serviceData.peak_usage_day.date} ($${serviceData.peak_usage_day.cost.toFixed(4)})</small>
                        </div>`
                    ).join('');
                    
                    document.getElementById('usageInfo').innerHTML = `
                        <h3>üîí ADMIN: Service-wise Costs (${daysParam} days)</h3>
                        <div style="max-height: 300px; overflow-y: auto;">${serviceList}</div>
                    `;
                }
            } catch (error) {
                document.getElementById('usageInfo').innerHTML = '<p>Admin access required</p>';
            }
        }
        
        async function getComprehensiveReport() {
            if (!currentUser) return;
            
            const days = prompt('Enter days for comprehensive admin report (default: 30):', '30');
            const daysParam = days ? parseInt(days) : 30;
            
            try {
                const response = await fetch(`${CONFIG.apiUrl}/api/admin/tenants/${currentUser.tenant_id}/comprehensive-report?days=${daysParam}`, {
                    headers: { 'Authorization': `Bearer ${currentUser.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const reportHtml = `
                        <h3>üîí ADMIN: Comprehensive Cost Report (${daysParam} days)</h3>
                        <div style="background: #f8d7da; padding: 15px; border-radius: 5px; border: 1px solid #f5c6cb;">
                            <h4>Summary</h4>
                            <p><strong>Total Cost:</strong> $${data.summary.total_tenant_cost.toFixed(4)}</p>
                            <p><strong>Total Users:</strong> ${data.summary.total_users}</p>
                            <p><strong>Highest Cost Service:</strong> ${data.summary.highest_cost_service}</p>
                            <p><strong>Most Expensive User:</strong> ${data.summary.most_expensive_user}</p>
                            
                            <h5>Top Users by Cost:</h5>
                            ${Object.entries(data['4_top_users_by_cost']).map(([userId, userData]) => 
                                `<p>${userId}: $${userData.total_cost.toFixed(4)}</p>`
                            ).join('')}
                        </div>
                    `;
                    document.getElementById('usageInfo').innerHTML = reportHtml;
                }
            } catch (error) {
                document.getElementById('usageInfo').innerHTML = '<p>Admin access required</p>';
            }
        }

        function logout() {
            if (cognitoUser) {
                cognitoUser.signOut();
            }
            currentUser = null;
            currentSession = null;
            cognitoUser = null;
            
            document.getElementById('chatInterface').classList.remove('active');
            document.getElementById('loginForm').classList.add('active');
            document.getElementById('chatBox').innerHTML = '';
            document.getElementById('usageInfo').innerHTML = '';
            document.getElementById('adminControls').style.display = 'none';
        }

        // Allow Enter key to send message
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>